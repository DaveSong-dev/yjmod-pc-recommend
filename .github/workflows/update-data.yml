name: 데이터 자동 갱신 (6시간 주기)

on:
  # 6시간마다 자동 실행 (UTC 기준 0, 6, 12, 18시 → KST 9, 15, 21, 3시)
  schedule:
    - cron: '0 0,6,12,18 * * *'

  # 수동 실행 (GitHub Actions 탭에서 "Run workflow" 클릭)
  workflow_dispatch:
    inputs:
      skip_products:
        description: '제품 크롤러 건너뛰기'
        required: false
        default: 'false'
        type: boolean
      skip_cafe:
        description: '카페 크롤러 건너뛰기'
        required: false
        default: 'false'
        type: boolean

# 동시 실행 방지 (이전 실행이 완료될 때까지 대기)
concurrency:
  group: update-data
  cancel-in-progress: false

jobs:
  crawl-and-update:
    name: 크롤링 및 데이터 갱신
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write   # 커밋 + 푸시 권한

    steps:
      # ─── 1. 코드 체크아웃 ────────────────────────────────────
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      # ─── 2. Python 설치 ──────────────────────────────────────
      - name: Python 3.11 설치
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'crawler/requirements.txt'

      # ─── 3. 의존성 설치 ──────────────────────────────────────
      - name: Python 의존성 설치
        run: |
          pip install --upgrade pip
          pip install -r crawler/requirements.txt

      # ─── 4. Chrome 설치 (Selenium용) ──────────────────────────
      - name: Chrome 브라우저 설치
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: 'stable'

      # ─── 5. 제품 크롤러 실행 ────────────────────────────────
      - name: 영재컴퓨터 제품 데이터 크롤링
        if: ${{ github.event.inputs.skip_products != 'true' }}
        working-directory: crawler
        env:
          PYTHONUNBUFFERED: '1'
          PYTHONIOENCODING: 'utf-8'
        run: |
          echo "===== 제품 크롤러 시작 ====="
          python crawl_products.py
          echo "===== 제품 크롤러 완료 ====="
        continue-on-error: true  # 실패해도 이전 데이터 유지

      # ─── 6. 카페 출고사진 크롤러 실행 ───────────────────────
      - name: 네이버 카페 출고사진 크롤링
        if: ${{ github.event.inputs.skip_cafe != 'true' }}
        working-directory: crawler
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_ID: ${{ secrets.NAVER_ID }}
          NAVER_PW: ${{ secrets.NAVER_PW }}
          PYTHONUNBUFFERED: '1'
          PYTHONIOENCODING: 'utf-8'
        run: |
          echo "===== 카페 크롤러 시작 ====="
          python crawl_cafe.py
          echo "===== 카페 크롤러 완료 ====="
        continue-on-error: true  # 실패해도 이전 데이터 유지

      # ─── 7. 변경사항 확인 ───────────────────────────────────
      - name: 변경사항 확인
        id: check_changes
        run: |
          git diff --name-only data/
          if git diff --quiet data/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "데이터 변경사항 없음"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "데이터 변경 감지됨:"
            git diff --stat data/
          fi

      # ─── 8. 변경사항 커밋 & 푸시 ────────────────────────────
      - name: 데이터 파일 커밋 및 푸시
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # Git 설정
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 데이터 파일만 스테이징
          git add data/pc_data.json data/cafe_posts.json

          # 커밋 메시지에 타임스탬프 포함 (KST)
          TIMESTAMP=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
          git commit -m "data: 자동 갱신 - ${TIMESTAMP}"

          # 푸시
          git push origin HEAD

          echo "✅ 데이터 갱신 완료: ${TIMESTAMP}"

      # ─── 9. 변경 없을 때 알림 ───────────────────────────────
      - name: 변경사항 없음 알림
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "ℹ️ 데이터 변경사항이 없습니다. 커밋 생략."

      # ─── 10. 실행 요약 ──────────────────────────────────────
      - name: 실행 결과 요약
        if: always()
        run: |
          echo "## 크롤링 실행 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시간**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')" >> $GITHUB_STEP_SUMMARY
          echo "- **트리거**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f data/pc_data.json ]; then
            PRODUCT_COUNT=$(python3 -c "import json; d=json.load(open('data/pc_data.json')); print(len(d.get('products', [])))" 2>/dev/null || echo "?")
            echo "- **제품 수**: ${PRODUCT_COUNT}개" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/cafe_posts.json ]; then
            POST_COUNT=$(python3 -c "import json; d=json.load(open('data/cafe_posts.json')); print(len(d.get('posts', [])))" 2>/dev/null || echo "?")
            echo "- **카페 게시글**: ${POST_COUNT}개" >> $GITHUB_STEP_SUMMARY
          fi
